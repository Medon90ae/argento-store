<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة إدارة Argento</title>
<style>
 body { font-family: sans-serif; background:#f7f7f7; margin:0; padding:20px; }
 .card { background:#fff; padding:20px; margin-bottom:20px; border-radius:12px; box-shadow:0 2px 6px #0001; }
 label { display:block; margin:6px 0 2px; }
 input, select, textarea { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
 button { padding:10px 18px; border:none; border-radius:8px; cursor:pointer; background:#0a7; color:#fff; margin-top:10px; }
 .danger { background:#c00; }
 table { width:100%; border-collapse:collapse; margin-top:10px; }
 th, td { border:1px solid #ddd; padding:8px; text-align:center; }
 th { background:#eee; }
</style>
</head>
<body>
<div class="card" id="authBox">
 <h2>تسجيل دخول لوحة الإدارة</h2>
 <label>ادخل السر</label>
 <input id="secretInput" type="text" placeholder="argento2024">
 <button onclick="checkSecret()">دخول</button>
</div>

<div id="app" style="display:none;">
 <div class="card">
   <h2>المنتجات</h2>
   <button onclick="openAddProduct()">إضافة منتج</button>
   <table id="productsTable"></table>
 </div>

 <div class="card">
   <h2>استيراد من كتالوج فيسبوك</h2>
   <label>Access Token</label>
   <input id="fbToken" type="text">
   <label>ID الكتالوج أو الصفحة</label>
   <input id="fbCatalogId" type="text">
   <button onclick="importFacebookCatalog()">استيراد</button>
   <div id="fbImportResult"></div>
 </div>

 <div class="card">
   <h2>الطلبات</h2>
   <button onclick="exportOrdersCSV()">تصدير CSV</button>
   <table id="ordersTable"></table>
 </div>
</div>

<script>
/* حماية الدخول */
function checkSecret(){
  const v = document.getElementById('secretInput').value.trim();
  if(v === 'argento2024'){ localStorage.setItem('argento_admin','1'); startApp(); }
  else alert('السر غير صحيح');
}
if(localStorage.getItem('argento_admin')==='1'){ startApp(); }
function startApp(){ document.getElementById('authBox').style.display='none'; document.getElementById('app').style.display='block'; loadProducts(); loadOrders(); }

/* إدارة الكتالوج */
let catalog = JSON.parse(localStorage.getItem('argento_catalog_v3')||'[]');
let orders = JSON.parse(localStorage.getItem('argento_orders_v3')||'[]');

function saveCatalog(){ localStorage.setItem('argento_catalog_v3', JSON.stringify(catalog)); loadProducts(); }

function loadProducts(){
  const t = document.getElementById('productsTable');
  t.innerHTML = '<tr><th>اسم</th><th>السعر</th><th>رابط</th><th>تعديل</th><th>حذف</th></tr>';
  catalog.forEach(p=>{
    t.innerHTML += `<tr>
      <td>${p.title}</td>
      <td>${p.price}</td>
      <td><a href="${p.website||'#'}" target="_blank">فتح</a></td>
      <td><button onclick="editProduct('${p.id}')">تعديل</button></td>
      <td><button class='danger' onclick="delProduct('${p.id}')">حذف</button></td>
    </tr>`
  });
}

function openAddProduct(){
  const title = prompt('اسم المنتج'); if(!title) return;
  const price = prompt('السعر'); if(!price) return;
  const id = 'p'+Date.now();
  const product = { id, title, price, website:'', salesCount:0, freeShipping:false, freeShippingMinQty:null };
  catalog.push(product);
  generateProductLink(product);
  saveCatalog();
}

function editProduct(id){
  const p = catalog.find(x=>x.id===id);
  if(!p) return;
  const title = prompt('اسم المنتج', p.title); if(!title) return;
  const price = prompt('السعر', p.price); if(!price) return;
  p.title = title;
  p.price = price;
  generateProductLink(p);
  saveCatalog();
}

function delProduct(id){
  if(!confirm('حذف المنتج؟')) return;
  catalog = catalog.filter(x=>x.id!==id);
  saveCatalog();
}

/* توليد رابط المنتج */
function generateProductLink(p){
  p.website = `https://medon90ae.github.io/argento-store/?product=${encodeURIComponent(p.title)}&price=${p.price}&sender=Sharqia&area=Zagazig&address=الزقازيق&phone=01055688136&senderName=Argento`;
}

/* الطلبات */
function loadOrders(){
  const t = document.getElementById('ordersTable');
  t.innerHTML = '<tr><th>اسم</th><th>هاتف</th><th>منتج</th><th>سعر</th></tr>';
  orders.forEach(o=>{
    t.innerHTML += `<tr>
      <td>${o.name}</td>
      <td>${o.phone}</td>
      <td>${o.product}</td>
      <td>${o.total}</td>
    </tr>`
  });
}

function exportOrdersCSV(){
  let csv = 'name,phone,product,total\n';
  orders.forEach(o=>{ csv += `${o.name},${o.phone},${o.product},${o.total}\n`; });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='orders.csv'; a.click();
}

/* استيراد كتالوج فيسبوك */
async function importFacebookCatalog(){
  document.getElementById('fbImportResult').innerText = 'جاري الاتصال...';
  const token = document.getElementById('fbToken').value.trim();
  const id = document.getElementById('fbCatalogId').value.trim();
  if(!token || !id){ alert('ادخل البيانات'); return; }
  try{
    const r = await fetch(`https://graph.facebook.com/v24.0/${id}/products?access_token=${token}`);
    const j = await r.json();
    if(j.data){ mergeFacebook(j.data); document.getElementById('fbImportResult').innerText='تم الاستيراد'; }
    else document.getElementById('fbImportResult').innerText='فشل الاستيراد';
  }catch(e){ document.getElementById('fbImportResult').innerText='خطأ بالاتصال'; }
}

function mergeFacebook(arr){
  arr.forEach(item=>{
    const title = item.name;
    if(!catalog.find(x=>x.title===title)){
      const id = 'fb'+Date.now()+Math.random();
      const price = (item.price_amount || 0)/100;
      const p = { id, title, price, website:'', salesCount:0, freeShipping:false, freeShippingMinQty:null };
      generateProductLink(p);
      catalog.push(p);
    }
  });
  saveCatalog();
}
</script>
</body>
</html>
