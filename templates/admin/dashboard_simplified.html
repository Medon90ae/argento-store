<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - Argento Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: #f5f5f5;
            direction: rtl;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin-bottom: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .stat-card.orders i { color: #4CAF50; }
        .stat-card.pending i { color: #FF9800; }
        .stat-card.confirmed i { color: #2196F3; }
        .stat-card.products i { color: #9C27B0; }
        
        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .stat-card p {
            color: #666;
            font-size: 16px;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .section-header h2 {
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #5568d3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-store"></i> لوحة تحكم Argento Store</h1>
            <p>إدارة المنتجات والطلبات</p>
        </div>
    </div>
    
    <div class="container">
        <!-- الإحصائيات -->
        <div class="stats-grid">
            <div class="stat-card orders">
                <i class="fas fa-shopping-cart"></i>
                <h3 id="total-orders">0</h3>
                <p>إجمالي الطلبات</p>
            </div>
            
            <div class="stat-card pending">
                <i class="fas fa-clock"></i>
                <h3 id="pending-orders">0</h3>
                <p>طلبات معلقة</p>
            </div>
            
            <div class="stat-card confirmed">
                <i class="fas fa-check-circle"></i>
                <h3 id="confirmed-orders">0</h3>
                <p>طلبات مؤكدة</p>
            </div>
            
            <div class="stat-card products">
                <i class="fas fa-box"></i>
                <h3 id="total-products">0</h3>
                <p>المنتجات</p>
            </div>
        </div>
        
        <!-- الأزرار الرئيسية -->
        <div class="section">
            <h3 style="margin-bottom: 15px;">إجراءات سريعة</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="updateCatalog()">
                    <i class="fas fa-sync"></i> تحديث الكتالوج
                </button>
                <button class="btn btn-secondary" onclick="updateLinks()">
                    <i class="fas fa-link"></i> تحديث الروابط
                </button>
                <button class="btn btn-primary" onclick="exportSpeedaf()">
                    <i class="fas fa-file-export"></i> تصدير Speedaf
                </button>
            </div>
        </div>
        
        <!-- التبويبات -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('products')">
                <i class="fas fa-box"></i> المنتجات
            </button>
            <button class="tab" onclick="switchTab('orders')">
                <i class="fas fa-shopping-cart"></i> الطلبات
            </button>
        </div>
        
        <!-- قسم المنتجات -->
        <div id="products-tab" class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <h2>المنتجات المتاحة</h2>
                </div>
                <div id="products-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>جاري تحميل المنتجات...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- قسم الطلبات -->
        <div id="orders-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>الطلبات الأخيرة</h2>
                </div>
                <div id="orders-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // متغيرات عامة
        let products = [];
        let orders = [];
        
        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
        
        // تحميل بيانات اللوحة
        async function loadDashboardData() {
            await Promise.all([
                loadStats(),
                loadProducts(),
                loadOrders()
            ]);
        }
        
        // تحميل الإحصائيات
        async function loadStats() {
            try {
                const response = await fetch('/api/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-orders').textContent = data.total_orders;
                    document.getElementById('pending-orders').textContent = data.pending_orders;
                    document.getElementById('confirmed-orders').textContent = data.confirmed_orders;
                    document.getElementById('total-products').textContent = data.total_products;
                }
            } catch (error) {
                console.error('خطأ في تحميل الإحصائيات:', error);
            }
        }
        
        // تحميل المنتجات
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                if (data.success && data.products) {
                    products = data.products;
                    displayProducts();
                } else {
                    document.getElementById('products-list').innerHTML = 
                        '<div class="empty"><i class="fas fa-box-open fa-3x"></i><p>لا توجد منتجات متاحة</p></div>';
                }
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                document.getElementById('products-list').innerHTML = 
                    '<div class="empty"><i class="fas fa-exclamation-triangle fa-2x"></i><p>حدث خطأ في تحميل المنتجات</p></div>';
            }
        }
        
        // عرض المنتجات
        function displayProducts() {
            if (products.length === 0) {
                document.getElementById('products-list').innerHTML = 
                    '<div class="empty"><i class="fas fa-box-open fa-3x"></i><p>لا توجد منتجات</p></div>';
                return;
            }
            
            let html = '<table class="table"><thead><tr><th>الصورة</th><th>اسم المنتج</th><th>السعر</th><th>التاجر</th><th>رابط الصفحة</th></tr></thead><tbody>';
            
            products.forEach(product => {
                const title = product.title || product.name || 'بدون اسم';
                const price = product.price || 0;
                const merchant = product.merchant_name || 'غير محدد';
                const image = product.image || product.image_url || 'https://via.placeholder.com/50';
                const landingUrl = product.website || product.landing_url || '#';
                
                html += `
                    <tr>
                        <td><img src="${image}" alt="${title}" class="product-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>${title}</td>
                        <td>${price.toLocaleString('ar-EG')} ج</td>
                        <td>${merchant}</td>
                        <td>
                            <button class="copy-btn" onclick="copyLink('${landingUrl}')">
                                <i class="fas fa-copy"></i> نسخ الرابط
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('products-list').innerHTML = html;
        }
        
        // تحميل الطلبات
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                const data = await response.json();
                
                if (data.success && data.orders) {
                    orders = data.orders;
                    displayOrders();
                } else {
                    document.getElementById('orders-list').innerHTML = 
                        '<div class="empty"><i class="fas fa-shopping-cart fa-3x"></i><p>لا توجد طلبات</p></div>';
                }
            } catch (error) {
                console.error('خطأ في تحميل الطلبات:', error);
                document.getElementById('orders-list').innerHTML = 
                    '<div class="empty"><i class="fas fa-exclamation-triangle fa-2x"></i><p>حدث خطأ في تحميل الطلبات</p></div>';
            }
        }
        
        // عرض الطلبات
        function displayOrders() {
            if (orders.length === 0) {
                document.getElementById('orders-list').innerHTML = 
                    '<div class="empty"><i class="fas fa-shopping-cart fa-3x"></i><p>لا توجد طلبات</p></div>';
                return;
            }
            
            let html = '<table class="table"><thead><tr><th>رقم الطلب</th><th>العميل</th><th>المنتج</th><th>المبلغ</th><th>الحالة</th><th>التاريخ</th></tr></thead><tbody>';
            
            orders.forEach(order => {
                const orderId = order.order_id || 'غير محدد';
                const customerName = order.customer_name || 'غير محدد';
                const productTitle = order.product_title || 'غير محدد';
                const totalAmount = order.total_amount || 0;
                const status = order.status || 'pending';
                const createdAt = order.created_at ? new Date(order.created_at).toLocaleDateString('ar-EG') : 'غير محدد';
                
                const badgeClass = status === 'confirmed' ? 'badge-confirmed' : 
                                  status === 'delivered' ? 'badge-success' : 'badge-pending';
                const statusText = status === 'confirmed' ? 'مؤكد' : 
                                  status === 'delivered' ? 'مسلم' : 'معلق';
                
                html += `
                    <tr>
                        <td><strong>${orderId}</strong></td>
                        <td>${customerName}</td>
                        <td>${productTitle}</td>
                        <td>${totalAmount.toLocaleString('ar-EG')} ج</td>
                        <td><span class="badge ${badgeClass}">${statusText}</span></td>
                        <td>${createdAt}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('orders-list').innerHTML = html;
        }
        
        // التبديل بين التبويبات
        function switchTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة التحديد من جميع الأزرار
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار التبويب المحدد
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // تحديد الزر
            event.target.closest('.tab').classList.add('active');
        }
        
        // تحديث الكتالوج
        async function updateCatalog() {
            if (!confirm('هل تريد تحديث الكتالوج من فيسبوك؟')) return;
            
            try {
                const response = await fetch('/admin/update-catalog', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ تم تحديث الكتالوج بنجاح!');
                    loadDashboardData();
                } else {
                    alert('❌ خطأ: ' + data.error);
                }
            } catch (error) {
                alert('❌ حدث خطأ أثناء التحديث');
            }
        }
        
        // تحديث الروابط
        async function updateLinks() {
            if (!confirm('هل تريد تحديث روابط صفحات الهبوط؟')) return;
            
            try {
                const response = await fetch('/admin/update-product-links', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ تم تحديث الروابط بنجاح!');
                    loadProducts();
                } else {
                    alert('❌ خطأ: ' + data.error);
                }
            } catch (error) {
                alert('❌ حدث خطأ أثناء التحديث');
            }
        }
        
        // تصدير Speedaf
        async function exportSpeedaf() {
            try {
                const response = await fetch('/admin/export-speedaf');
                const data = await response.json();
                
                if (data.success && data.csv_content) {
                    // تنزيل الملف
                    const blob = new Blob([data.csv_content], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = data.filename;
                    link.click();
                    
                    alert('✅ تم تصدير الملف بنجاح!');
                } else {
                    alert('⚠️ لا توجد طلبات للتصدير');
                }
            } catch (error) {
                alert('❌ حدث خطأ أثناء التصدير');
            }
        }
        
        // نسخ الرابط
        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('✅ تم نسخ الرابط!');
            }).catch(err => {
                alert('❌ فشل نسخ الرابط');
            });
        }
    </script>
</body>
</html>
