{% extends "base.html" %}
{% block title %}الصفحة الرئيسية{% endblock %}

{% block content %}
{# Landing fallback: show detailed product when products is single-item list #}
{% if products and products|length == 1 %}
  {% set product = products[0] %}
  <div class="container py-4">
    <div class="row">
      <div class="col-md-6">
        {% if product.image %}
          <img src="{{ product.image }}" class="img-fluid" alt="{{ product.title }}">
        {% else %}
          <img src="/static/images/logo.png" class="img-fluid" alt="">
        {% endif %}
      </div>
      <div class="col-md-6">
        <h2>{{ product.title or product.name }}</h2>
        <p>{{ product.get('description') or product.get('short_description','') }}</p>
        <h4>{{ product.price }} {{ product.currency or '' }}</h4>

        <form id="landing-order-form" method="post" action="/api/landing_order">
          <input type="hidden" name="product_id" value="{{ product.get('id') or product.get('sku') or (product.website|default('')|split('/')[-1]) }}">
          <div class="mb-2"><input name="name" class="form-control" placeholder="الاسم" required></div>
          <div class="mb-2"><input name="phone" class="form-control" placeholder="رقم الهاتف" required></div>
          <div class="mb-2"><input name="city" class="form-control" placeholder="المدينة" required></div>
          <div class="mb-2"><input name="area" class="form-control" placeholder="المنطقة" required></div>
          <div class="mb-2"><textarea name="address" class="form-control" placeholder="العنوان" required></textarea></div>
          <button class="btn btn-primary" type="submit">تأكيد الطلب</button>
        </form>

        <div id="msg" class="mt-2"></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const form = document.getElementById('landing-order-form');
    if(!form) return;
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const data = new FormData(form);
      const res = await fetch(form.action, {method:'POST', body: data});
      const json = await res.json();
      const msg = document.getElementById('msg');
      if(json.ok){ msg.innerText = 'تم تسجيل الطلب. رقم: ' + json.order_id; form.reset(); }
      else { msg.innerText = 'خطأ: ' + (json.error || 'غير معروف'); }
    });
  })();
  </script>

{% else %}
  {# Products grid/list view #}
  <div class="container py-4">
    <div class="row">
      {% for product in products %}
        <div class="col-md-4 mb-3">
          <div class="card">
            {% if product.image %}
              <img src="{{ product.image }}" class="card-img-top" alt="{{ product.title }}">
            {% endif %}
            <div class="card-body">
              <h5 class="card-title">{{ product.title }}</h5>
              <p class="card-text">{{ product.price }} {{ product.currency or '' }}</p>
              <a href="{{ product.website or ('/landing/' ~ (product.id|string)) }}" class="btn btn-outline-primary" target="_blank">صفحة المنتج</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}
{% endblock %}
