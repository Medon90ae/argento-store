name: Fetch Facebook Catalogs - Safe & Debuggable

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Read secrets (explicit)
        id: read_secrets
        run: |
          echo "Reading secrets..."
          echo "SUDIID_len=${#SUDIID}" >> $GITHUB_OUTPUT || true
        env:
          SUDIID: ${{ secrets.SUDIID }}
          UNILEVERID: ${{ secrets.UNILEVERID }}
          BUSSNISID: ${{ secrets.BUSSNISID }}
          FB_TOKEN: ${{ secrets.FBACCSESSTOKEN }}

      - name: Validate required secrets
        run: |
          missing=0
          echo "Checking secrets presence..."
          if [ -z "${{ secrets.FBACCSESSTOKEN }}" ]; then echo "ERROR: secret FBACCSESSTOKEN is MISSING"; missing=1; fi
          if [ -z "${{ secrets.SUDIID }}" ]; then echo "WARN: secret SUDIID is EMPTY"; fi
          if [ -z "${{ secrets.UNILEVERID }}" ]; then echo "WARN: secret UNILEVERID is EMPTY"; fi
          if [ -z "${{ secrets.BUSSNISID }}" ]; then echo "WARN: secret BUSSNISID is EMPTY"; fi
          if [ "$missing" -eq 1 ]; then echo "One or more required secrets are missing. Please add them to Repo Settings → Secrets and Variables → Actions"; exit 1; fi

      - name: Attempt to fetch product_count for each catalog (quick check)
        env:
          FB_TOKEN: ${{ secrets.FBACCSESSTOKEN }}
          SUDIID: ${{ secrets.SUDIID }}
          UNILEVERID: ${{ secrets.UNILEVERID }}
          BUSSNISID: ${{ secrets.BUSSNISID }}
        run: |
          set -e
          for CID in "$SUDIID" "$UNILEVERID" "$BUSSNISID"; do
            if [ -z "$CID" ]; then
              echo "Skipping empty catalog id"
              continue
            fi
            echo "Checking catalog $CID ..."
            resp=$(curl -s "https://graph.facebook.com/v24.0/$CID?fields=id,name,product_count&access_token=$FB_TOKEN")
            echo "$resp" | jq .
            ok=$(echo "$resp" | jq -r '.id // empty')
            if [ -z "$ok" ]; then
              echo "Warning: Could not read catalog $CID (check token permissions or ID)"
            fi
            sleep 0.5
          done

      - name: Robust fetch (auto-detect edge + gather)
        env:
          FB_TOKEN: ${{ secrets.FBACCSESSTOKEN }}
          SUDIID: ${{ secrets.SUDIID }}
          UNILEVERID: ${{ secrets.UNILEVERID }}
          BUSSNISID: ${{ secrets.BUSSNISID }}
        run: |
          set -euo pipefail
          mkdir -p tmp
          > tmp/all_lines.jsonl

          # helper: fetch items for a catalog ID
          fetch_catalog() {
            CID="$1"
            echo "---- processing $CID ----"
            meta=$(curl -s "https://graph.facebook.com/v24.0/$CID?metadata=1&access_token=$FB_TOKEN")
            echo "$meta" | jq '.metadata.connections' > tmp/meta_${CID}.json || true
            echo "Edges for $CID:"
            jq -r 'keys[]' tmp/meta_${CID}.json || true

            # choose candidate edge
            for e in products product_items items; do
              if jq -e "has(\"$e\")" tmp/meta_${CID}.json >/dev/null 2>&1; then
                chosen="$e"
                break
              else
                chosen=""
              fi
            done

            if [ -z "${chosen:-}" ] && jq -e 'has("product_sets")' tmp/meta_${CID}.json >/dev/null 2>&1; then
              echo "Catalog has product_sets — will iterate sets"
              # fetch sets then their products
              page="https://graph.facebook.com/v24.0/$CID/product_sets?limit=100&access_token=$FB_TOKEN"
              while [ -n "$page" ]; do
                http_code=$(curl -s -w "%{http_code}" -o tmp/resp_sets.json "$page")
                if [ "$http_code" != "200" ]; then echo "Error fetching sets for $CID http:$http_code"; cat tmp/resp_sets.json || true; break; fi
                jq -c '.data[]' tmp/resp_sets.json 2>/dev/null > tmp/sets_lines || true
                if [ -f tmp/sets_lines ]; then
                  while read -r line; do
                    set_id=$(echo "$line" | jq -r '.id')
                    echo " -> fetching products for set $set_id"
                    page2="https://graph.facebook.com/v24.0/$set_id/products?limit=100&access_token=$FB_TOKEN&fields=id,name,retailer_id,price_amount,price_currency,image_url,images,availability,status"
                    while [ -n "$page2" ]; do
                      http_code2=$(curl -s -w "%{http_code}" -o tmp/resp_set_prod.json "$page2")
                      if [ "$http_code2" != "200" ]; then echo "Set products fetch failed http:$http_code2"; cat tmp/resp_set_prod.json || true; break; fi
                      jq -c '.data[]' tmp/resp_set_prod.json 2>/dev/null >> tmp/all_lines.jsonl || true
                      page2=$(jq -r '.paging.next // empty' tmp/resp_set_prod.json)
                      if [ -z "$page2" ]; then break; fi
                      sleep 0.3
                    done
                  done < tmp/sets_lines
                fi
                page=$(jq -r '.paging.next // empty' tmp/resp_sets.json)
                if [ -z "$page" ]; then break; fi
              done
              return
            fi

            if [ -z "${chosen:-}" ]; then
              echo "No known product edge for $CID — saved metadata for review"
              return
            fi

            echo "Using edge '$chosen' for $CID"
            page="https://graph.facebook.com/v24.0/$CID/$chosen?limit=100&access_token=$FB_TOKEN&fields=id,name,retailer_id,price_amount,price_currency,retailer_price,image_url,images,availability,status"
            while [ -n "$page" ]; do
              http_code=$(curl -s -w "%{http_code}" -o tmp/resp.json "$page")
              if [ "$http_code" != "200" ]; then
                echo "HTTP $http_code while fetching $chosen for $CID"
                cat tmp/resp.json || true
                break
              fi
              jq -c '.data[]' tmp/resp.json 2>/dev/null >> tmp/all_lines.jsonl || true
              page=$(jq -r '.paging.next // empty' tmp/resp.json)
              if [ -z "$page" ]; then break; fi
              sleep 0.3
            done
          }

          for id in "$SUDIID" "$UNILEVERID" "$BUSSNISID"; do
            if [ -n "$id" ]; then fetch_catalog "$id"; else echo "skip empty id"; fi
          done

          if [ -f tmp/all_lines.jsonl ]; then
            jq -s 'map({
              id: (.id // .retailer_id // ""),
              title: (.name // .title // .retailer_title // ""),
              price: ((.price_amount // .retailer_price // .price // 0) | tonumber),
              currency: (.price_currency // "EGP"),
              image: (.image_urls[0] // .image_url // .images[0].uri // .images[0] // ""),
              raw: .
            })' tmp/all_lines.jsonl > catalog.json || echo "[]" > catalog.json
          else
            echo "No items fetched"
            echo "[]" > catalog.json
          fi

          echo "catalog.json length: $(jq 'length' catalog.json)"
          jq '.[0:5]' catalog.json || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: catalog-json
          path: catalog.json

      - name: Commit & push (attempt)
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          set -e
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add catalog.json || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update catalog.json (auto) [skip ci]" || true
            BRANCH="${GITHUB_REF#refs/heads/}"
            git push origin "HEAD:$BRANCH" || echo "Push failed"
          fi
