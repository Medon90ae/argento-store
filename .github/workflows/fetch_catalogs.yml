name: Fetch Facebook Catalogs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # يحدث الكتالوج كل 6 ساعات (اختياري)

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Debug Secrets Presence
      env:
        FB_TOKEN: ${{ secrets.FBACCSESSTOKEN }}
        CATALOG1: ${{ secrets.SUDIID }}
        CATALOG2: ${{ secrets.UNILEVERID }}
        CATALOG3: ${{ secrets.BUSSNISID }}
      run: |
        echo "Token present? $( [ -n "$FB_TOKEN" ] && echo YES || echo NO )"
        echo "CATALOG1 length: ${#CATALOG1}"
        echo "CATALOG2 length: ${#CATALOG2}"
        echo "CATALOG3 length: ${#CATALOG3}"

    - name: Create empty catalog file
      run: echo "[]" > catalog.json

    - name: Fetch catalogs
      id: fetch_step
      env:
        FB_TOKEN: ${{ secrets.FBACCSESSTOKEN }}
        CATALOG1: ${{ secrets.SUDIID }}
        CATALOG2: ${{ secrets.UNILEVERID }}
        CATALOG3: ${{ secrets.BUSSNISID }}
      run: |
        echo "Fetching all catalogs..."

        # function لتحميل كتالوج واحد
        fetch_catalog () {
          CID=$1
          NAME=$2

          if [ -z "$CID" ]; then
            echo "Skipping $NAME (EMPTY ID)"
            return
          fi

          echo "Fetching catalog $NAME with ID $CID"

          curl -s "https://graph.facebook.com/v24.0/$CID/products?limit=500&access_token=$FB_TOKEN" \
            -o "temp_$NAME.json"

          echo "Merging $NAME ..."
          jq -s '.[0] + .[1].data' catalog.json "temp_$NAME.json" > catalog_temp.json
          mv catalog_temp.json catalog.json
        }

        fetch_catalog "$CATALOG1" "catalog1"
        fetch_catalog "$CATALOG2" "catalog2"
        fetch_catalog "$CATALOG3" "catalog3"

    - name: Commit catalog.json
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "updated catalog.json"
        file_pattern: catalog.json
