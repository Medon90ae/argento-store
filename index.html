
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Argento Store — تسجيل الطلب</title>
<style>
  /* Modern, Shopify-like simple styling (mobile-first) */
  :root{
    --accent:#27ae60;
    --muted:#6b7280;
    --bg:#f7fafc;
    --card:#ffffff;
    --radius:12px;
    --shadow: 0 8px 30px rgba(2,6,23,0.06);
  }
  body{margin:0;font-family:Inter, "Segoe UI", Tahoma, Arial;background:var(--bg);color:#111}
  .container{max-width:1100px;margin:18px auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{font-size:20px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px}
  @media(min-width:980px){ .layout{grid-template-columns: 2fr 420px} }

  /* product card / gallery */
  .product-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;display:flex;flex-direction:column;gap:12px}
  .gallery{display:flex;gap:10px;align-items:center}
  .main-img{width:100%;height:320px;border-radius:10px;object-fit:cover;background:#f0f3f5;border:1px solid #eef2f6}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .thumb{width:72px;height:72px;border-radius:8px;object-fit:cover;border:1px solid #eef2f6;cursor:pointer}
  .product-meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .title{font-size:20px;font-weight:700}
  .price{font-size:20px;color:var(--accent);font-weight:800}

  /* form */
  form{display:flex;flex-direction:column;gap:12px}
  label{font-weight:700;margin-bottom:6px}
  input[type="text"],input[type="tel"],select,textarea{padding:14px;border-radius:10px;border:1px solid #e6eef6;font-size:16px;width:100%;box-sizing:border-box}
  textarea{min-height:96px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:160px}
  .btn{background:linear-gradient(135deg,var(--accent),#2ecc71);border:none;color:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn.secondary{background:#f3f6f9;color:#0b1220;border:1px solid #e6eef6}
  .info-box{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2f6}
  .summary{background:#fff;padding:14px;border-radius:12px;border:1px solid #eef2f6}
  .small-muted{font-size:13px;color:var(--muted)}
/* product grid (catalog) */
  .catalog-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .catalog-card{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #f0f4f8;display:flex;flex-direction:column;gap:8px}
  .catalog-image{width:100%;height:140px;border-radius:8px;object-fit:cover;background:#f3f5f7}

  footer{margin-top:16px;color:var(--muted);font-size:13px}

  /* small helpers */
  .tag{display:inline-block;padding:6px 8px;border-radius:8px;background:#ecfdf3;color:#065f46;font-weight:700;font-size:13px}
  .danger{background:#fff6f6;color:#922; padding:6px;border-radius:8px;border:1px solid #f5d6d6}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Argento Store</h1>
        <div class="muted">تسجيل الطلب — صفحة المشتري (Shopify-like)</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <a href="admin.html?secret=argento2024" target="_blank" class="muted small-muted">لوحة الإدارة</a>
        <button id="btnFetchCatalog" class="btn secondary">استيراد الكتالوج</button>
      </div>
    </header>

    <main class="layout">
      <!-- Left: Product / Order -->
      <section>
        <div id="productArea" class="product-card">
          <!-- product info injected by JS -->
        </div>

        <!-- catalog suggestions below -->
        <div style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>منتجات مقترحة</strong> <div class="small-muted">مرتبة حسب العروض و الأكثر مبيعًا</div></div>
            <div id="catalogStats" class="small-muted"></div>
          </div>
          <div id="catalogGrid" class="catalog-grid" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- Right: Order form / summary -->
      <aside>
        <div class="summary">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>سلة سريعة</strong><div class="small-muted">مراجعة الطلب قبل الإرسال</div></div>
            <div id="cartCount" class="tag">0</div>
          </div>

          <div id="cartItems" style="margin-top:12px"></div>

          <div style="margin-top:12px">
            <label>اسم المستلم</label>
            <input id="customerName" type="text" placeholder="أدخل اسم المستلم" />

            <label style="margin-top:10px">هاتف المستلم</label>
            <input id="customerPhone" type="tel" placeholder="مثال: 01012345678" />

            <label style="margin-top:10px">المدينة</label>
            <select id="customerCity"></select>

            <label style="margin-top:10px">المنطقة</label>
            <select id="customerArea"></select>

            <label style="margin-top:10px">العنوان التفصيلي</label>
            <textarea id="customerAddress" placeholder="شارع، عمارة، الدور"></textarea>

            <div id="validationMsg" class="small-muted" style="margin-top:8px;color:#922"></div>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="btnSubmitOrder" class="btn" style="flex:1">إرسال الطلب</button>
              <button id="btnClearCart" class="btn secondary" style="width:120px">تفريغ</button>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="info-box">
          <div class="small-muted">ملاحظة: سعر الوحدة يتضاعف حسب الكمية. الشحن ثابت حتى الوصول لشروط عرض الشحن الخاص بالمنتج.</div>
        </div>
      </aside>
    </main>

    <footer>
      <div class="muted">الراسل الثابت: Argento — 01055688136 — Sharqia / Zagazig</div>
    </footer>
  </div>

<script>

   Configuration & storage keys
   ========================= */
const STORE_KEYS = {
  CATALOG: 'argento_catalog_v3',
  ORDERS: 'argento_orders_v3'
};

const FIXED_SENDER = {
  senderName: 'Argento',
  senderPhone: '01055688136',
  senderCity: 'Sharqia',
  senderArea: 'Zagazig',
  senderAddress: 'حي الزهور شارع اولاد جبر'
};

const DEFAULT_FB_PAGE_ID = '1605226514252142';
const DEFAULT_FB_ACCESS_TOKEN = "EAAYnZATZAgiVMBQIVlJZBEY4ecqENjmDBA8ZAcTbnUuiv4inhgnxdEuFiXOkbLMe2MI2CW0rtGsTw6bWjTjEDyNGljSmRW7tUpWZBfqn6wMFmT1j2feRxsVmI09bAJIMvn0hSrZATqWghELZAcojocAJ8xzDKRsFhgwE4stnc0cTmUAsn4UZCEmJeh5q5nYVZBAZDZD";

/* =========================
   Data state
   ========================= */
let catalog = JSON.parse(localStorage.getItem(STORE_KEYS.CATALOG) || 'null') || [];
let orders = JSON.parse(localStorage.getItem(STORE_KEYS.ORDERS) || '[]');
let cart = []; // items to order before confirm (each {productId, title, unitPrice, qty, image})

/* =========================
   Example initial catalog if empty (you can import real from FB)
   ========================= */
if(!catalog || catalog.length === 0){
  catalog = [
    { id:'p_serum', title:'سيروم فيتامين سي', price:120, image:'https://via.placeholder.com/800x600?text=Serum', salesCount:120, freeShipping:false, freeShippingMinQty:null, website:'' },
    { id:'p_oil', title:'زيت شعر طبيعي', price:160, image:'https://via.placeholder.com/800x600?text=Hair+Oil', salesCount:85, freeShipping:true, freeShippingMinQty:3, website:'' },
    { id:'p_cleanser', title:'غسول للبشرة', price:95, image:'https://via.placeholder.com/800x600?text=Cleanser', salesCount:200, freeShipping:false, freeShippingMinQty:null, website:'' }
  ];
  localStorage.setItem(STORE_KEYS.CATALOG, JSON.stringify(catalog));
}

/* =========================
   Utility helpers
   ========================= */
function uid(prefix='id'){ return prefix + '_' + Date.now() + '_' + Math.floor(Math.random()*9000); }
function saveCatalog(){ localStorage.setItem(STORE_KEYS.CATALOG, JSON.stringify(catalog)); }
function saveOrders(){ localStorage.setItem(STORE_KEYS.ORDERS, JSON.stringify(orders)); }
function saveCart(){ /* not persisted intentionally */ renderCart(); }
function formatMoney(n){ return (Math.round(n*100)/100).toLocaleString('ar-EG') + ' ج'; }
function findProduct(pid){ return catalog.find(p=>p.id === pid); }

/* =========================
   Render main product area (when visiting product link or default first product)
   Behavior: if URL contains product param -> show that product page
   ========================= */

function getURLProductParam(){
  const params = new URLSearchParams(window.location.search);
  return params.get('productId') || params.get('product') || null;
}

function renderProductArea(){
  const prodParam = getURLProductParam();
  let product = null;
  if(prodParam){
    product = findProduct(prodParam) || catalog.find(c=>encodeURIComponent(c.title) === prodParam) || null;
  }
  if(!product) product = catalog[0];

  const area = document.getElementById('productArea');
  area.innerHTML = ''; // build product view
  const html = document.createElement('div');
  html.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;gap:12px;flex-direction:column">
        <img id="mainImage" class="main-img" src="${product.image || ''}" alt="${escapeHtml(product.title)}" />
        <div class="thumbs" id="thumbs"></div>
      </div>

      <div class="product-meta">
        <div>
          <div class="title">${escapeHtml(product.title)}</div>
          <div class="small-muted">منتج — <span id="productIdBadge">${product.id}</span></div>
        </div>
        <div style="text-align:left">
          <div class="price">${formatMoney(product.price)}</div>
          <div class="muted small-muted">${product.freeShipping ? ('شحن مجاني من ' + (product.freeShippingMinQty ? product.freeShippingMinQty + ' قطعة' : 'أي كمية')) : 'شحن عادي'}</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <label style="margin:0;font-weight:700">الكمية</label>
          <input id="productQty" type="number" value="1" min="1" style="width:100px;padding:10px;border-radius:10px;border:1px solid #eef2f6" />
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="btnAddCart" class="btn secondary">أضف إلى السلة</button>
          <button id="btnBuyNow" class="btn">اطلب الآن</button>
        </div>
      </div>

      <div class="small-muted">وصف قصير للمنتج (يمكن تعديل الوصف في صفحة الإدارة)</div>
    </div>
  `;
  area.appendChild(html);

  // thumbs (if product.images array exists use it)
  const thumbs = document.getElementById('thumbs');
  const mainImg = document.getElementById('mainImage');
  const images = product.images && product.images.length ? product.images : [product.image];
  images.forEach(src=>{
    if(!src) return;
    const t = document.createElement('img');
    t.src = src; t.className = 'thumb';
    t.addEventListener('click', ()=> mainImg.src = src);
    thumbs.appendChild(t);
  });

  // bind add to cart
  document.getElementById('btnAddCart').addEventListener('click', ()=>{
    const qty = Math.max(1, parseInt(document.getElementById('productQty').value) || 1);
    addToCart(product.id, qty);
  });

  // buy now: add and go to order form (scroll to form)
  document.getElementById('btnBuyNow').addEventListener('click', ()=>{
    const qty = Math.max(1, parseInt(document.getElementById('productQty').value) || 1);
    addToCart(product.id, qty);
    // scroll to order panel
    document.querySelector('aside').scrollIntoView({behavior:'smooth'});
  });
}

   Catalog grid (suggestions) - sorted by free shipping then salesCount desc
   ========================= */

function renderCatalogGrid(){
  const grid = document.getElementById('catalogGrid');
  grid.innerHTML = '';
  // sort: freeShipping first, then salesCount desc
  const sorted = catalog.slice().sort((a,b)=>{
    if((b.freeShipping?1:0) - (a.freeShipping?1:0) !== 0) return (b.freeShipping?1:0) - (a.freeShipping?1:0);
    return (b.salesCount || 0) - (a.salesCount || 0);
  });
  sorted.forEach(p=>{
    const card = document.createElement('div'); card.className='catalog-card';
    card.innerHTML = `
      <img class="catalog-image" src="${p.image || ''}" alt="${escapeHtml(p.title)}" />
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(p.title)}</div>
          <div class="small-muted">${p.salesCount || 0} مبيعاً</div>
        </div>
        <div style="text-align:left">
          <div style="font-weight:800;color:var(--accent)">${formatMoney(p.price)}</div>
          ${p.freeShipping ? '<div class="tag">عرض شحن</div>' : ''}
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn secondary btn-select-product" data-id="${p.id}">مشاهدة</button>
        <button class="btn btn-generate-link" data-id="${p.id}">نسخ رابط</button>
      </div>
    `;
    grid.appendChild(card);
  });

  // bindings
  grid.querySelectorAll('.btn-select-product').forEach(b=> b.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id;
    const url = window.location.pathname + '?productId=' + encodeURIComponent(id);
    window.history.pushState({}, '', url);
    renderProductArea();
    window.scrollTo({top:0,behavior:'smooth'});
  }));

  grid.querySelectorAll('.btn-generate-link').forEach(b=>{
    b.addEventListener('click', async e=>{
      const id = e.currentTarget.dataset.id;
      const link = generateOrderLinkForProduct(id);
      await copyText(link);
      // save website in catalog entry
      const item = findProduct(id);
      if(item){ item.website = link; saveCatalog(); renderCatalogGrid(); }
      alert('تم نسخ رابط الطلب');
    });
  });

  document.getElementById('catalogStats').textContent = `${catalog.length} منتج`;
}

/* =========================
   Cart logic & UI (right panel)
   ========================= */
function addToCart(productId, qty=1){
  const p = findProduct(productId);
  if(!p) return alert('المنتج غير موجود');
  const existing = cart.find(c=>c.productId === productId);
  if(existing){ existing.qty += qty; }
  else { cart.push({ productId, title: p.title, unitPrice: p.price, qty: qty, image: p.image }); }
  saveCart();
}

function removeFromCart(productId){
  cart = cart.filter(c=>c.productId !== productId);
  saveCart();
}

function changeQty(productId, newQty){
  const it = cart.find(c=>c.productId===productId); if(!it) return;
  it.qty = Math.max(1, newQty); saveCart();
}

function renderCart(){
  const el = document.getElementById('cartItems');
  el.innerHTML = '';
  if(cart.length === 0){ el.innerHTML = '<div class="small-muted">السلة فارغة</div>'; document.getElementById('cartCount').textContent = '0'; return; }
  document.getElementById('cartCount').textContent = String(cart.reduce((s,i)=>s+i.qty,0));
  cart.forEach(item=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='8px';
    row.innerHTML = `
      <img src="${item.image || ''}" alt="" style="width:72px;height:72px;border-radius:8px;object-fit:cover;border:1px solid #eef2f6" />
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(item.title)}</div>
        <div class="small-muted">${formatMoney(item.unitPrice)}</div>
        <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
          <input type="number" min="1" value="${item.qty}" data-pid="${item.productId}" style="width:84px;padding:8px;border-radius:8px;border:1px solid #eef2f6" />
          <button class="btn secondary btn-remove" data-id="${item.productId}" style="padding:8px 10px">حذف</button>
        </div>
      </div>
      <div style="text-align:left;font-weight:800">${formatMoney(item.unitPrice * item.qty)}</div>
    `;
    el.appendChild(row);
  });

  // bind qty inputs and remove buttons
  el.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const pid = e.target.dataset.pid; const v = parseInt(e.target.value) || 1; changeQty(pid, v);
    });
  });
  el.querySelectorAll('.btn-remove').forEach(b=> b.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id; removeFromCart(id);
  }));
}

/* =========================
   Validation: Address & Phone
   - remove symbols from address (allow letters, numbers, space, comma, dot, dash, Arabic letters)
   - phone must be exactly 11 digits (Egypt)
   ========================= */
const addressInput = document.getElementById('customerAddress');
addressInput.addEventListener('input', ()=>{
  // allow Arabic letters \u0600-\u06FF, basic Latin letters, numbers, space, comma, dot, hyphen, parentheses
  const allowed = /[^\u0600-\u06FF\u0750-\u077F\w0-9\s\.,\-\(\)\u0621-\u064A]/g;
  // remove forbidden characters
  const val = addressInput.value;
  const clean = val.replace(allowed, '');
  if(clean !== val) addressInput.value = clean;
});

const phoneInput = document.getElementById('customerPhone');
phoneInput.addEventListener('input', ()=>{
  // remove non-digits
  phoneInput.value = phoneInput.value.replace(/\D/g,'').slice(0,11);
});

   Submit order: validate and save to orders (same key as admin)
   ========================= */
document.getElementById('btnSubmitOrder').addEventListener('click', ()=>{
  // validations
  const name = document.getElementById('customerName').value.trim();
  const phone = document.getElementById('customerPhone').value.trim();
  const city = document.getElementById('customerCity').value;
  const area = document.getElementById('customerArea').value;
  const address = document.getElementById('customerAddress').value.trim();

  if(!name){ showValidation('أدخل اسم المستلم'); return; }
  if(!/^\d{11}$/.test(phone)){ showValidation('رقم الهاتف يجب أن يكون 11 رقم (مثال: 01012345678)'); return; }
  if(!city){ showValidation('اختر المدينة'); return; }
  if(!area){ showValidation('اختر المنطقة'); return; }
  if(!address){ showValidation('أدخل العنوان بالتفصيل'); return; }
  if(cart.length === 0) { showValidation('السلة فارغة — أضف منتجات'); return; }

  // compute totals: consider product-level freeShipping min qty
  const orderItems = cart.map(ci=>{
    const p = findProduct(ci.productId);
    return {
      productId: ci.productId,
      productTitle: p.title,
      unitPrice: p.price,
      qty: ci.qty,
      image: p.image,
      freeShipping: p.freeShipping || false,
      freeShippingMinQty: p.freeShippingMinQty || null
    };
  });

  // shipping: we treat shipping per order: default computeShipping based on sender+receiver and product offers
  let shippingPerOrder = 0;
  // choose highest priority: if any single product triggers its freeShipping by qty -> free shipping for whole order
  const anyProductFree = orderItems.some(it => it.freeShipping && it.freeShippingMinQty && it.qty >= it.freeShippingMinQty);
  const anyProductFreeAlways = orderItems.some(it => it.freeShipping && !it.freeShippingMinQty);
  if(anyProductFreeAlways || anyProductFree){
    shippingPerOrder = 0;
  } else {
    // default: compute shipping by sender city and receiver city using simplified rules
    shippingPerOrder = calculateShipping(FIXED_SENDER.senderCity, city);
  }

  const itemsTotal = orderItems.reduce((s,it)=>s + (it.unitPrice * it.qty),0);
  const total = itemsTotal + shippingPerOrder;

  const newOrder = {
    id: uid('ORD'),
    createdAt: new Date().toISOString(),
    receiverName: name,
    receiverPhone: phone,
    receiverCity: city,
    receiverArea: area,
    receiverAddress: address,
    senderName: FIXED_SENDER.senderName,
    senderPhone: FIXED_SENDER.senderPhone,
    senderCity: FIXED_SENDER.senderCity,
    senderArea: FIXED_SENDER.senderArea,
    items: orderItems,
    shippingCost: shippingPerOrder,
    itemsTotal,
    total
  };

  orders.push(newOrder);
  saveOrders();
  // clear cart and form
  cart = [];
  saveCart();
  document.getElementById('customerName').value=''; document.getElementById('customerPhone').value=''; document.getElementById('customerAddress').value='';
  document.getElementById('customerCity').selectedIndex = 0; document.getElementById('customerArea').innerHTML = '<option value="">اختر المنطقة</option>';
  showValidation('', true);
  alert('تم إرسال الطلب وحفظه بنجاح. سيتم عرضه في لوحة الإدارة.');
});

/* validation helper */
function showValidation(msg='', ok=false){
  const el = document.getElementById('validationMsg');
  el.textContent = msg;
  el.style.color = ok ? '#0b6623' : '#922';
}

   Shipping calculation (simple rules)
   ========================= */
function calculateShipping(senderCity, receiverCity){
  const base = 80;
  if(!senderCity || !receiverCity) return base;
  if(senderCity === receiverCity) return 65;
  if(senderCity === 'Alex' || receiverCity === 'Alex') return 75;
  const delta = ['Beheira','Gharbia','Dakahlia','Sharqia','Qalyubia','Menoufia','Damietta','Port Said','Ismailia','Suez','Kafr El Sheikh'];
  if(delta.includes(receiverCity) || delta.includes(senderCity)) return 85;
  const upper = ['Beni Suef','Fayoum','Minya','Assiut','Sohag','Qena'];
  if(upper.includes(receiverCity) || upper.includes(senderCity)) return 95;
  const far = ['Luxor','Aswan','Red Sea','New Valley','South Sinai','North Sinai','Matrouh'];
  if(far.includes(receiverCity) || far.includes(senderCity)) return 105;
  return base;
}

/* =========================
   City/Area selects initialization (uses your full dataset; here partial for brevity)
   You asked previously to include full mapping — extend as needed or paste your full citiesData in localStorage
 const citiesData = {
"AinShams":["Gamal abd Al naser","Qubaa","Moasst Al zakaah","Al Arbeen we Al khamseen","Al Herafyeen","Masr El Gadida","Heliopolis","El Nozha","El Marg","Ain Shams"],
"Al-agamy":["Al ameriya","Borg al arab","Qetaa at Tarik as Sahrawi","Port al-Basal","El-Agamy","Ekeingy Maryout","Dekhela","Ad Daerah Al Gomrokeyah"],
"Alex":["Qism Sidi Gabir","Qism El-Raml","Montaza 2 Qism Montaza","Al Mamurah","Abu Qir"],
"Aswan":["New Tushka","New Aswan","Nasser City","Madinet Nasr an Nobah","Kom Umbu","Edfu","Draw","Aswan Second","Aswan city","Al Gaafrah"],
"Asyut":["Sodfa","Sahel Selim","New Asyut","Manfalut","El-Ghanayem","EL Fateh","Asyut Sharq","Asyut gharb","Al Maabdah","Al Badari","Abu Tij","Abnub"],
"Badrashin":["Manil Shihah","before Ayat","Badrashin Village","Ayat","Al-Hawamidiyya","After Ayat","Abu AL Numros","Mazghona"],
"Abu Tesht":["Abu Tesht"],
"Farshut":["Farshut"],
"Dar El-Salam":["Dar El-Salam"],
"Al Balena":["Al Balena"],
"Gerga":["Gerga"],
"Banha":["Tukh","Shibin El Qanater","Qalyub","Kafr Shukr","El Qanater El Khayreya","Banha"],
"Behira":["Shubrakhit","Rasheed","Mahmoudiyah","Kom Hamada","Kafr El Dawwar","Itay Al Barud","Edku","Damanhour","Badr","Al Delengat","Abu Hummus"],
"BeniSuef":["Sumusta","Salah Salem","New Beni Suef","Nasser","Ihnasiya","ELFAYOM ROAD","ELFASHN","Biba","Aziz Moqbel","Abd El-Salam Aref"],
"Helwan":["Atfeh"],
"Damietta":["Ras El Bar","New Damietta","Kafr Saad","Kafr El Battikh","Faraskur","Damietta Port","Damietta"],
"Dekernes":["Shirbin","Mit Salsil","Menyet El Nasr","Mahallat Damanah","El Matareya","El Manzala","El Kurdi","El Gamaliya","Dikirnis","Bani Ebeid"],
"Desouk":["Rahmaniya","Sidi Salem","Qallin","Metoubes","Fuwwah","Desouk"],
"Dokki":["Zamalek","Saftawy","Mohandisen","Manial","Kit Kat","Elmotamedeya St.","Dokki","Bragel","Bolak Al Dakrour","Ard Elwa","Al Agouzah","Ameer city","Nahia El Bald","Kafr Hakem","Ezbet el saayda"],
"Downtown":["Shubra Masr","Rod El Farag","Ramses","Qasr El Nil","Garden City","Elsahel","El-Abaseya","El Zawya El Hamra","El Sharabiya","El Sayeda Zeinab","El Obra","El Daher","Bab El Sharia","Ataba","Al Fagalah","Al Azbakeya","Abo El Ela","Abdeen","Elgamalya","Eldrasa","Ghamra","Bab El loq"],
"Abu Sinbil":["Abu Sinbil"],
"Administrative Capital":["Administrative Capital"],
"New Heliopolis City":["New Heliopolis City"],
"Cairo Governorate Desert":["Cairo Governorate Desert"],
"Zaafarana":["Zaafarana"],
"Shalateen":["Shalateen"],
"Marsa Alam":["Marsa Alam"],
"Halaib":["Halaib"],
"Sallum":["Sallum"],
"Siwa Oasis":["Siwa Oasis"],
"Sidi Barrani":["Sidi Barrani"],
"Farafra":["Farafra"],
"Dakhla":["Dakhla"],
"Kharga":["Kharga"],"Sharm El-Sheikh":["Sharm El-Sheikh"],
"Abu Radis":["Abu Radis"],
"Ain Sokhna":["Ain Sokhna"],
"Faiyum":["youssef Elsdyq","Wadi El-Rayyan","Tamiyyah","Sinnuris","Kufur an Nil","Itsa","Ibsheway","Faiyum center","Al Faiyum Al Gadida"],
"Faqus":["Tanis","San Al Hagar","New Salhia","Monshaat Abou Omar","Kafr Saqr","Faqous","El Salheya","El Husseiniya","Awlad Saqr","Abu Kebir"],
"Fardos":["Hadayk alahram","AL Remaya","Zewil District","Sakan Masr","Road Wahat","Othman District","Mountain View","Mall Masr","Haram city","Hadayk October","Fardous city","Dream Land","Degla Balmez","Dar Masr","Al Ashjar distriict","800 Fadan","Ebny Betak","Dahshour"],
"Hadayk Ahram":["Libyan Faisal","Mariouteya Faisal","Mehwar sides","Mansorya","Faisal","Monshaat Al Bakkari","Kerdasa","Kafr Ghatati","Ezbet El Salmawy","Bani Magdoul","Abou Rawash"],
"Haram":["Zaghloul area","Sisi area","Abo alhoal Elsyaahy","Kafr Al-Jabal","Haram Mashaal","Libyan Haram","Tersa","Saqiyet Mekki","Omrania","Munib","Al Haram","El Bahr El Aazam","El Talbeya Haram","El Maryoutia Haram","Terssa El Balad"],
"Helwan":["Kafr Elalw","Helwan","Hadayek helwan","El saf","Al Tebin","Al Maasarah Al Mahattah","El Maasara","Wady Hof","May"],
"Hurghada":["Sahl Hasheesh","Safaga","Ras Gharib","Hurghada","El Qusair"],
"Ismailia":["Tell El Kebir","Ismailia Free Zone","Ismailia","Industrial Zone in Ismailia","Fayed","El-Kasasin","El Qantara","Abu Suwir","Abu Sultan","Ksarfrit"],
"Kafr El-Sheikh":["Kafr El-Shaikh","El-Hamoul","El Reyad","Burullus","Biyala","Baltiem"],
"Khanka":["Ala3bd","Troly","Spiko","Al Nahda","Saryaqus","El-Salam","El Ubour","Al Qalaj","Al Manayil","Al Khankah","Al Gabal Al Asfar","Abu Zabal"],
"Luxor":["Teba","Minshat Al Ammari","Madinet Al Bayadeyah","Luxor City","El-Boghdady","Armant","Al-Radwaniya","Al Toud City","Al Qarnah","Al Madamoud","Esna","Al Hebeel"],
"Maadi":["Dar El-Salam","Zahraa Al Maadi","Tura","Taqseem El-Laselky","Sarayat El-Maadi","Sakanat El-Maadi","Qism El-Khalifa","New Maadi","Masr Helwan Agri. Road","Mansheya Nasir","Maadi corniche","Maadi","Hadayek El-Maadi","El-Qamar El-Senae (Sattellite)","El Mokattam","El Katameya","El Basatin","Degla","Arab El-Maadi"],
"Mahala":["Samannoud","El Mahalla El Kubra"],
"Mansoura":["Tamai El Amadid","Talkha","Nabaruh","Mit Ghamr","Gamasa","El-Senbellawein","El Mansoura","Belqas","Aga"],
"Matamir":["Shamal Altahrir","Noubariah","Natrn Valley","Hosh Essa","Abu El Matamir"],
"Dayrout":["Dayrout"],
"Al Qusiyyah":["Al Qusiyyah"],
"Malawi":["Malawi"],
"Dayr Mawas":["Dayr Mawas"],
"Menya":["Samalut","New Menya","Minya City","Matay","Maghagha","Madinet Al Adwah","Beni Mazar","Abu Qurqas"],
"Monufia":["Tala","Sirs Al Layyanah","Shibin el Kom","Quwaysna","Menouf","El Shohada","El Sadat City","El Bagour","Birket El Sab","Ashmoun","Al Khatatbah"],
"Nasr City":["Gardenia City","Zahraa Nasr City","Sheraton","Makram Ebeid","El Tayaran St","El Serag Mall","At Taseah","Ard el golf","Almazah","Al Hay Al Asher","Abbas El-Akkad","Tag Sultan Compound","Tag City Compound","First District","Emtdad Ramses","El Sekka Club","Elmoqaolon ElArab","Eighth District","Eighth District & Projects","Ezbet El Haggana","El Waha & Hassan El Momenoun Extension","El Wafaa & El Amal Real Estate Buildings","Sixth District","Seventh District & Sefarat","Swiss District"],
"New Cairo":["The 5th Settlement","The 3th Settlement","The 1th Settlement","Al Rehab"],
"Matrouh":["Mersa Matruh","El Dabaa"],
"North Coast":["North Coast","El-Alamein","El Hamam"],
"Oct6th":["West Somid October","Smart Village","Sheikh Zayed City","Districts 6th of october","District motameez october"],
"Port said":["Qism El-Arab","Port Fuad 2","Port Fuad","Mubarak Neighborhood","El Zohur","El Sharq","El Manasra","El Manakh","El Hay Elamarty","EL GHARB","El Dawahy","Al Ganoub"],
"Qena":["Qus","Qift","Qena","New Qena","Naqada","Nagaa Hammadi","Dishna","Al Waqf"],
"Sharqia":["Zagazig","Minya El Qamh","Mashtol Al Souq","Hihya","El Qurein","El Qanayat","El Ibrahimiya","Diyarb Negm","Bilbeis","Abu Hammad"],
"Shorouk":["Madinaty","Future City (AL Mostakbal)","Badr City","Al Shorouk"],
"Shoubara El Khima":["Umm Bayoumi","Musturad  2","Musturad  1","Mit NEMA","El-Wehda","Basus","Bahtem","Asfour Crystal","Ahmed Oraby","Mantay","Abo El Gheet","Balaqs"],
"Sohag":["Tima","Tahta","Sohag","Shandawil","Saqultah","New Sohag","New Akhmim","Juhaynah West","Geheinah","El Kawtar","Aserat","Al Minshah","Al Maraghah","Akhmim"],
"Suez":["Faisal","Suez","Port Taofik","Ganayen","Attaka","Arbaeen"],
"Tanash":["Manshyt Elqanater","Imbaba","Bashtel","Awsim","Al Warak"],
"Tanta":["Zefta","Tanta","Qutur","Kafr El Zayat","El Santa","Basyoun"],
"Zayton":["Hadaiq Al Zayton","Halmya Al Zyton","El Weili","El Amireya","Hadaiq El Qobbah","Ezbat Elnahkl","EL Zayton","Almatarya","Al Khusus","Ain Shams Sharkia","Ain Shams Gharbia"],
"10th of Ramadan City":["10th of Ramadan City","Neighborhoods 1 to 17","Neighborhoods 18 to 34","Neighborhoods 35 to 50","Neighborhoods 51 to 66","Neighborhoods 67 to 99","district 11","district 12","Andalus district","district 10","district 13","district 14","district 15","district 16","First Industrial Zone","Second Industrial Zone","Third Industrial Zone","district 28","district 29","district 30","district 31","district 32","district 33","Al-Shahabi Area","Sanyia Misr Al-Nour","Sanyia Misr Al-Hijaz","Al-Urduniya","Sidnawi"]
}
function initCityAreaSelects(){
  const citySel = document.getElementById('customerCity');
  const areaSel = document.getElementById('customerArea');
  citySel.innerHTML = '<option value="">اختر المدينة</option>';
  Object.keys(citiesData).forEach(city=>{
    const opt = document.createElement('option'); opt.value = city; opt.textContent = city; citySel.appendChild(opt);
  });
  citySel.addEventListener('change', ()=>{
    const c = citySel.value;
    areaSel.innerHTML = '<option value="">اختر المنطقة</option>';
    if(c && citiesData[c]) citiesData[c].forEach(a=>{
      const o = document.createElement('option'); o.value = a; o.textContent = a; areaSel.appendChild(o);
    });
  });
}

   Fetch Facebook catalog (dedupe) - minimal
   - Will create synthetic items based on product_count (see note)
   ========================= */
async function fetchFacebookCatalog(pageId=DEFAULT_FB_PAGE_ID, accessToken=DEFAULT_FB_ACCESS_TOKEN){
  const info = document.getElementById('btnFetchCatalog');
  info.disabled = true; info.textContent = 'جاري التحميل...';
  try{
    const url = `https://graph.facebook.com/v24.0/${encodeURIComponent(pageId)}?fields=id,name,product_count&access_token=${encodeURIComponent(accessToken)}`;
    const res = await fetch(url);
    if(!res.ok){ alert('فشل جلب الكتالوج: ' + res.status); info.disabled=false; info.textContent='استيراد الكتالوج'; return; }
    const json = await res.json();
    const count = Math.min(20, json.product_count || 6);
    const newItems=[];
    for(let i=1;i<=count;i++){
      const id = `${json.id}_p_${i}`;
      if(catalog.some(x=>x.id === id)) continue;
      newItems.push({
        id,
        title: `${json.name || 'Catalog'} - item ${i}`,
        price: 80 + i*20,
        image: `https://via.placeholder.com/800x600?text=${encodeURIComponent(json.name+'-'+i)}`,
        salesCount: Math.floor(Math.random()*300),
        freeShipping: (i%4===0),
        freeShippingMinQty: (i%4===0?3:null),
        website: ''
      });
    }
    if(newItems.length === 0) alert('لا توجد منتجات جديدة للاستيراد أو أنها مُضافة من قبل.');
    catalog = catalog.concat(newItems);
    saveCatalog();
    renderCatalogGrid();
    renderProductArea(); // re-render in case first product was replaced
    alert('تم استيراد المنتجات.');
  }catch(err){
    alert('خطأ في استيراد الكتالوج: ' + err.message);
  } finally {
    info.disabled = false; info.textContent = 'استيراد الكتالوج';
  }
}

/* =========================
   Generate order link for product (used for copying/website column)
   ========================= */
function generateOrderLinkForProduct(productId){
  const p = findProduct(productId);
  if(!p) return window.location.href;
  const params = new URLSearchParams();
  params.set('productId', p.id);
  params.set('price', String(p.price));
  params.set('sender', FIXED_SENDER.senderCity);
  params.set('area', FIXED_SENDER.senderArea);
  params.set('address', FIXED_SENDER.senderAddress);
  params.set('phone', FIXED_SENDER.senderPhone);
  params.set('senderName', FIXED_SENDER.senderName);
  return window.location.origin + window.location.pathname + '?' + params.toString();
}

/* =========================
   Init boot
   ========================= */
function boot(){
  renderCatalogGrid();
  renderProductArea();
  renderCart();
  initCityAreaSelects();
}
boot();

/* =========================
   Expose utilities for console/admin quick edits
   ========================= */
window.catalog = catalog;
window.saveCatalog = saveCatalog;
window.addToCatalog = function(p){ catalog.push(p); saveCatalog(); renderCatalogGrid(); };
window.orders = orders;
window.generateOrderLinkForProduct = generateOrderLinkForProduct;

/* =========================
   small helper functions
   ========================= */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
async function copyText(t){ try{ await navigator.clipboard.writeText(t); return true; }catch(e){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); return true; } }

</script>
</body>
</html>